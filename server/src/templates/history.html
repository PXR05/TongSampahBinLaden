<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ESP32 History</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <div class="card">
      <div class="row">
        <h1 style="margin-right: auto">ESP32 History</h1>
        <a href="/" class="btn" title="Back to dashboard">← Dashboard</a>
      </div>
      <div class="row">
        <label for="deviceSelect">Device:</label>
        <select id="deviceSelect">
          <option value="">Loading…</option>
        </select>
        <label for="pageSize">Page size:</label>
        <input
          id="pageSize"
          type="number"
          value="25"
          min="5"
          max="200"
          step="5"
        />
        <button id="applyBtn" class="btn">Apply</button>
      </div>

      <div class="muted" id="statusText">Loading…</div>

      <div id="tableScroll" class="scrollBox">
        <table id="historyTable">
          <thead>
            <tr>
              <th>Time</th>
              <th>Device</th>
              <th>Distance (cm)</th>
              <th>Motion</th>
              <th>Servo (°)</th>
              <th>Target (°)</th>
              <th>Uptime (ms)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="pagination">
        <div class="page-controls">
          <button id="firstBtn" class="btn">« First</button>
          <button id="prevBtn" class="btn">‹ Prev</button>
          <span id="pageInfo" class="muted">Page 1 of 1</span>
          <button id="nextBtn" class="btn">Next ›</button>
          <button id="lastBtn" class="btn">Last »</button>
        </div>
        <div class="spacer"></div>
        <div class="muted" id="totalInfo">0 rows</div>
      </div>
    </div>

    <script>
      let state = { deviceId: "", page: 1, pageSize: 25, totalPages: 1 };
      let refreshHandle = null;
      let els;
      const REFRESH_MS = 2000;

      document.addEventListener("DOMContentLoaded", async () => {
        const $ = (id) => document.getElementById(id);
        els = {
          deviceSelect: $("deviceSelect"),
          pageSize: $("pageSize"),
          applyBtn: $("applyBtn"),
          prevBtn: $("prevBtn"),
          nextBtn: $("nextBtn"),
          firstBtn: $("firstBtn"),
          lastBtn: $("lastBtn"),
          pageInfo: $("pageInfo"),
          totalInfo: $("totalInfo"),
          statusText: $("statusText"),
          tableScroll: $("tableScroll"),
          historyTableBody: document.querySelector("#historyTable tbody"),
        };
        const params = new URLSearchParams(location.search);
        const qDevice = params.get("deviceId");
        const qPage = parseInt(params.get("page") || "1", 10);
        const qPageSize = parseInt(params.get("pageSize") || "25", 10);
        if (!Number.isNaN(qPage)) state.page = Math.max(1, qPage);
        if (!Number.isNaN(qPageSize))
          state.pageSize = Math.min(200, Math.max(5, qPageSize));

        await loadDevices(qDevice);
        await loadPage();

        els.prevBtn.addEventListener("click", () => gotoPage(state.page - 1));
        els.nextBtn.addEventListener("click", () => gotoPage(state.page + 1));
        els.firstBtn.addEventListener("click", () => gotoPage(1));
        els.lastBtn.addEventListener("click", () => gotoPage(state.totalPages));
        els.applyBtn.addEventListener("click", () => {
          const ps = parseInt(els.pageSize.value, 10);
          state.pageSize = Math.min(200, Math.max(5, isNaN(ps) ? 25 : ps));
          state.page = 1;
          syncUrl();
          loadPage();
        });
        els.deviceSelect.addEventListener("change", (e) => {
          state.deviceId = e.target.value;
          state.page = 1;
          syncUrl();
          loadPage();
        });

        startAutoRefresh();
        document.addEventListener("visibilitychange", handleVisibility);
        window.addEventListener("beforeunload", stopAutoRefresh);
      });

      async function loadDevices(preselect) {
        try {
          const res = await fetch("/api/devices");
          const j = await res.json();
          const ids = j.deviceIds || [];
          const sel = els.deviceSelect;
          sel.innerHTML =
            '<option value="">Select…</option>' +
            ids.map((id) => `<option value="${id}">${id}</option>`).join("");
          if (preselect && ids.includes(preselect)) {
            state.deviceId = preselect;
            sel.value = preselect;
          } else if (!state.deviceId && ids.length) {
            state.deviceId = ids[0];
            sel.value = state.deviceId;
          }
        } catch (e) {
          console.error("loadDevices", e);
        }
      }

      async function loadPage(silent = false) {
        if (!state.deviceId) {
          els.statusText.textContent = "Select a device";
          return;
        }
        try {
          if (!silent) els.statusText.textContent = "Loading…";
          const url = `/api/history-page?deviceId=${encodeURIComponent(
            state.deviceId
          )}&page=${state.page}&pageSize=${state.pageSize}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error("HTTP " + res.status);
          const j = await res.json();
          state.totalPages = j.totalPages || 1;
          state.page = j.page || 1;
          els.pageInfo.textContent = `Page ${state.page} of ${state.totalPages}`;
          els.totalInfo.textContent = `${j.total || 0} rows total`;
          els.pageSize.value = state.pageSize;
          renderRows(j.rows || []);
          if (!silent) els.statusText.textContent = "Loaded";
          updateButtons();
        } catch (e) {
          console.error("loadPage", e);
          els.statusText.textContent = "Failed to load page";
        }
      }

      function renderRows(rows) {
        const sc = els.tableScroll;
        const saved = sc ? sc.scrollTop : 0;
        els.historyTableBody.innerHTML = rows
          .map(
            (r) => `
          <tr>
            <td>${
              r.serverTimestamp
                ? new Date(r.serverTimestamp).toLocaleString()
                : ""
            }</td>
            <td>${r.deviceId || ""}</td>
            <td>${r.distance ?? ""}</td>
            <td>${r.motion ? "Detected" : "None"}</td>
            <td>${r.servoPosition ?? ""}</td>
            <td>${r.targetPosition ?? ""}</td>
            <td>${r.deviceUptimeMs ?? ""}</td>
          </tr>
        `
          )
          .join("");
        if (sc) sc.scrollTop = saved;
      }

      function updateButtons() {
        els.prevBtn.disabled = state.page <= 1;
        els.firstBtn.disabled = state.page <= 1;
        els.nextBtn.disabled = state.page >= state.totalPages;
        els.lastBtn.disabled = state.page >= state.totalPages;
      }

      function gotoPage(p) {
        const np = Math.max(1, Math.min(state.totalPages || 1, p));
        if (np === state.page) return;
        state.page = np;
        syncUrl();
        loadPage();
      }

      function syncUrl() {
        const params = new URLSearchParams();
        if (state.deviceId) params.set("deviceId", state.deviceId);
        params.set("page", String(state.page));
        params.set("pageSize", String(state.pageSize));
        history.replaceState(
          null,
          "",
          `${location.pathname}?${params.toString()}`
        );
      }

      function startAutoRefresh() {
        if (document.hidden) return;
        stopAutoRefresh();
        refreshHandle = setInterval(() => loadPage(true), REFRESH_MS);
      }

      function stopAutoRefresh() {
        if (refreshHandle) {
          clearInterval(refreshHandle);
          refreshHandle = null;
        }
      }

      function handleVisibility() {
        if (document.hidden) stopAutoRefresh();
        else startAutoRefresh();
      }
    </script>
  </body>
</html>
